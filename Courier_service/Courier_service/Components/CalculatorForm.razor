@using Courier_service.Services.LocationService
@using BlazorLeaflet
@using BlazorLeaflet.Models;

@inject IJSRuntime _jsRuntime
@inject IHttpClientFactory _clientFactory

@inherits Calculator


<MudCard>
	<MudCardContent>
		<MudForm>
			<MudTextField @onfocusout="validate" @bind-Value="@SendAddress" T="string" Label="Откуда" Required="true" RequiredError="Заполните адрес отправки!" />
			<MudTextField @onfocusout="validate" @bind-Value="@RecAddress" T="string" Label="Куда" Required="true" RequiredError="Заполните адрес доставки!" />
		</MudForm>
	</MudCardContent>
	<MudCardActions>
		@if (distance == 0 && downloading)
		{
			<MudProgressCircular Color="Color.Primary" Indeterminate="true" />
		}
		@if (distance > 0)
		{
			<MudText>от @price ₽</MudText>
		}
		<MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@invalid" Class="ml-auto" @onclick="CalculateDistance">Рассчитать</MudButton>
	</MudCardActions>
	@if (mapVisible && mapReady)
		{
			<div style="height: 400px; width: 100%;">
				<BlazorLeaflet.LeafletMap Map="@_map" />
			</div>
		}
</MudCard>

@code{
	[Inject]
	ISnackbar snackbar { get; set; }

	public void ShowErrorSnackBar(string message)
	{
		snackbar.Add(message, Severity.Error);
	}

	protected override void OnInitialized()
	{
		locationProvider = new LocationProvider(_clientFactory);
		_map = new Map(_jsRuntime);
		_map.OnInitialized += () =>
		{
			_map.OnContextMenu += (s, me) => { OpenPopup(s, me); };
			_mapController = new MapController(_jsRuntime, _clientFactory, _map);
			mapReady = true;
		};
		_map.Center = new LatLng(58.6035f, 49.668f);//58.6035, 49.668
		_map.Zoom = 8; _map.MinZoom = 8;
		_map.MaxBounds = Tuple.Create<LatLng, LatLng>(new LatLng(58.6784f, 49.4508f), new LatLng(58.545f, 49.8065f));//58.6784, 49.4508 - 58.54, 49.8065
		_map.RaiseOnInitialized();
		WrongAddress += (str) => { ShowErrorSnackBar(str); };
	}

	public void OpenPopup(Map sender, BlazorLeaflet.Models.Events.MouseEvent me)
	{
		_mapController.OpenMapPopup($"[{me.LatLng.Lat.ToString().Replace(',', '.')},{me.LatLng.Lng.ToString().Replace(',', '.')}]");
	}
}
